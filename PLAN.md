# Plan for Integrating react-native-google-cast

This document outlines the steps to integrate the `react-native-google-cast` library into the `opengame-app` project, manage state using `@open-game-system/app-bridge`, and adjust the Expo build process.

## Steps

- [x] 1.  **Install Dependency**:
    *   Add `react-native-google-cast` to the `dependencies` in the root `package.json`.

- [x] 2.  **Configure Expo Plugin**:
    *   Update the root `app.json` to include the `react-native-google-cast` config plugin in the `plugins` array. This will handle native project configuration (iOS `AppDelegate`, Android `AndroidManifest.xml`, etc.) during the prebuild phase.

- [x] 3.  **Update App Bridge Store (`app/index.tsx`)**:
    *   [x] Refine the `AppStores` type definition for `castKit` to include relevant state like device availability, connection status (e.g., `CAST_STATE_CONNECTED`, `CAST_STATE_CONNECTING`, `CAST_STATE_NOT_CONNECTED`), and potentially the current media status.
        ```typescript
        import { CastState, MediaStatus, SessionState } from 'react-native-google-cast';

        // Proposed State Structure
        interface CastKitState {
          // Connection & Device Discovery
          castState: CastState; // e.g., CastState.CONNECTED, CastState.CONNECTING, etc.
          devicesAvailable: boolean;

          // Session Management
          sessionState?: SessionState; // e.g., SessionState.SESSION_STARTED, SessionState.SESSION_ENDED

          // Media Playback
          mediaState?: MediaStatus.PlayerState; // e.g., PLAYER_STATE_PLAYING, PLAYER_STATE_PAUSED
          mediaInfo?: { // Structure based on typical MediaInfo
            title?: string;
            subtitle?: string;
            imageUrl?: string;
            contentUrl?: string; // Might not be needed in native state, depends on use case
          };
          streamPosition?: number; // Current playback time in seconds
          streamDuration?: number; // Total duration in seconds
          isLoading?: boolean; // Is media loading?
          volume?: number; // Device volume (0-1)
          isMuted?: boolean; // Device mute status
        }

        // Proposed Events
        type CastKitEvents =
          | { type: "SET_CAST_STATE"; payload: CastState }
          | { type: "SET_DEVICES_AVAILABLE"; payload: boolean }
          | { type: "SET_SESSION_STATE"; payload: SessionState | undefined }
          | { type: "SET_MEDIA_STATE"; payload: MediaStatus.PlayerState | undefined }
          | { type: "SET_MEDIA_INFO"; payload: CastKitState['mediaInfo'] | undefined }
          | { type: "SET_STREAM_POSITION"; payload: number | undefined }
          | { type: "SET_STREAM_DURATION"; payload: number | undefined }
          | { type: "SET_IS_LOADING"; payload: boolean | undefined }
          | { type: "SET_VOLUME"; payload: number | undefined }
          | { type: "SET_IS_MUTED"; payload: boolean | undefined };
        ```
    *   [x] Update the `castKit` store's `initialState`.
    *   [x] Implement a `producer` function for the `castKit` store to handle updates based on events from the `react-native-google-cast` library.
    *   [x] Add necessary imports from `react-native-google-cast` (e.g., `GoogleCast`, `useCastState`, `useDevices`, `useSession`, `useMediaStatus`, `useStreamPosition`).
    *   Use `useEffect` in the main app component (`app/index.tsx` or a dedicated component) to:
        *   [ ] Initialize the Cast context if required by the library (e.g., `GoogleCast.showIntroductoryOverlay()`). *Needs implementation if required.*
        *   [x] Listen for changes in cast state (`useCastState`), device availability (`useDevices`), session state (`useSession`), media status (`useMediaStatus`), and stream position (`useStreamPosition`).
        *   [x] Dispatch actions to the `castKit` store via the bridge when these states change.
    *   [x] Integrate the `CastButton` component from `react-native-google-cast` into the UI to allow users to initiate casting.

- [ ] 4.  **Update Build Process**:
    *   Since `react-native-google-cast` includes native code, the standard Expo Go app cannot be used.
    *   A custom development build or a preview/production build is required.
    *   Use `npx expo prebuild` (if managing native folders locally) or rely on EAS Build (`eas build --profile development` or `eas build --profile preview/production`) to apply the config plugin changes.
    *   Run the app using `npx expo run:ios` or `npx expo run:android` for the development build, or install the build generated by EAS.

## Considerations

*   **Native Configuration**: The Expo config plugin handles most native setup, but review the `react-native-google-cast` documentation for any manual steps required (e.g., Google Cast SDK setup in Google Cloud Console, obtaining an App ID).
*   **UI Components**: Decide where and how to display the `CastButton` in `app/index.tsx`.
*   **State Management**: Determine the exact structure of the `castKit` state needed for the application (e.g., tracking media playback info) within `app/index.tsx`.
*   **Error Handling**: Implement error handling for casting connection issues in `app/index.tsx`.